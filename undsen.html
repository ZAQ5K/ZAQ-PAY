<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Undsen • MySite</title>
<style>
body { font-family: Arial, sans-serif; background: #eef2f7; display: flex; justify-content: center; padding-top: 40px; }
.dashboard { background: #fff; width: 550px; padding: 30px 40px; border-radius: 12px; box-shadow: 0 12px 36px rgba(0,0,0,0.15); }
h1 { font-size: 28px; color: #2563eb; margin-bottom: 20px; }
.wallet { margin-top: 15px; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
.wallet span.value { font-weight: bold; }
.transfer { margin-top: 30px; display:flex; gap:10px; flex-wrap:wrap; }
.transfer input { flex:1; padding:10px; border-radius:8px; border:1px solid #d1d5db; font-size:15px; }
.transfer button { padding:10px 15px; border-radius:8px; border:none; background:#16a34a; color:white; font-weight:bold; cursor:pointer; }
.transfer button:hover { background:#15803d; }
.logout-btn { margin-top: 20px; width:100%; padding:12px; border:none; border-radius:8px; background:#ef4444; color:white; font-weight:bold; cursor:pointer; }
.logout-btn:hover { background:#b91c1c; }
</style>
</head>
<body>

<div class="dashboard">
  <h1 id="username">Нэвтэрсэн хэрэглэгч</h1>
  <div class="wallet">
    <span>Таны хэтэвч:</span>
    <span id="wallet" class="value">0 ₮</span>
  </div>

  <div class="transfer">
    <input type="text" id="recipientName" placeholder="Хүлээн авагчийн нэр">
    <input type="number" id="transferAmount" placeholder="Шилжүүлэх дүн">
    <button onclick="transfer()">Мөнгө шилжүүлэх</button>
  </div>

  <button class="logout-btn" onclick="logout()">Гарах</button>

  <!-- Firebase users list (Admin view, optional) -->
  <ul id="userList" style="margin-top:20px; text-align:left; font-size:14px;"></ul>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAbcCE3MINVNUvMpw1YEFjrm9xJhCFgFHc",
    authDomain: "zaq-pay-a4256.firebaseapp.com",
    projectId: "zaq-pay-a4256",
    storageBucket: "zaq-pay-a4256.firebasestorage.app",
    messagingSenderId: "349261684381",
    appId: "1:349261684381:web:20816605dfbaacb4fbbe74"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Get current user from LocalStorage
  let currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if(!currentUser){
    alert("Та эхлээд нэвтэрнэ үү!");
    window.location.href = "login1.html";
  }

  // Wallet undefined бол 0
  if(!currentUser.wallet || isNaN(currentUser.wallet)) currentUser.wallet = 0;

  function formatMoney(amount){ return amount.toLocaleString('mn-MN') + " ₮"; }
  document.getElementById("username").innerText = currentUser.name;
  document.getElementById("wallet").innerText = formatMoney(currentUser.wallet);

  // Realtime Firebase listener (users)
  const userList = document.getElementById('userList');
  db.ref('users').on('value', snapshot => {
    userList.innerHTML = '';
    snapshot.forEach(child => {
      const u = child.val();
      const li = document.createElement('li');
      li.textContent = Name: ${u.name}, Wallet: ${formatMoney(u.wallet || 0)};
      userList.appendChild(li);

      // Update currentUser wallet if matching email
      if(u.email === currentUser.email){
        currentUser.wallet = u.wallet || 0;
        document.getElementById("wallet").innerText = formatMoney(currentUser.wallet);
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
      }
    });
  });

  // Money transfer
  function transfer(){
    let amount = Number(document.getElementById("transferAmount").value);
    let recipientName = document.getElementById("recipientName").value.trim();

    if(!recipientName){ alert("Хүлээн авагчийн нэрийг оруулна уу!"); return; }
    if(amount <= 0){ alert("Зөв дүн оруулна уу!"); return; }
    if(amount > currentUser.wallet){ alert("Таны хэтэвч хангалтгүй байна!"); return; }

    const usersRef = db.ref('users');
    usersRef.once('value').then(snapshot => {
      let recipientEntry;
      snapshot.forEach(child => {
        const u = child.val();
        if(u.name.toLowerCase() === recipientName.toLowerCase()){
          recipientEntry = { key: child.key, data: u };
        }
      });

      if(!recipientEntry){
        alert("Ийм нэртэй хэрэглэгч олдсонгүй!");
        return;
      }
      if(recipientEntry.data.email === currentUser.email){
        alert("Өөртөө шилжүүлэх боломжгүй!");
        return;
      }

      // Update wallets in Firebase
      const updates = {};
      updates['users/' + recipientEntry.key + '/wallet'] = (recipientEntry.data.wallet || 0) + amount;

      // Find currentUser key
      snapshot.forEach(child => {
        const u = child.val();
        if(u.email === currentUser.email){
          updates['users/' + child.key + '/wallet'] = currentUser.wallet - amount;
        }
      });

      db.ref().update(updates).then(()=>{
        alert(formatMoney(amount) + " амжилттай шилжлээ " + recipientName + " рүү!");
        document.getElementById("transferAmount").value = "";
        document.getElementById("recipientName").value = "";
      }).catch(err=>{
        console.error(err);
        alert("Алдаа гарлаа!");
      });
    });
  }

  // Logout
  function logout(){
    localStorage.removeItem("currentUser");
    window.location.href = "login1.html";
  }
</script>

</body>
</html>
